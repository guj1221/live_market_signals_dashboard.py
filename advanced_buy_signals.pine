//@version=5
indicator("Advanced Buy Signals & Tools", overlay=true, max_labels_count=500)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================
// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, maxval=100)
rsiOverbought = input.float(70, "RSI Overbought Level", minval=50, maxval=100)
rsiOversold = input.float(30, "RSI Oversold Level", minval=0, maxval=50)

// MACD Settings
macdFastLength = input.int(12, "MACD Fast Length", minval=1, maxval=100)
macdSlowLength = input.int(26, "MACD Slow Length", minval=1, maxval=100)
macdSignalLength = input.int(9, "MACD Signal Length", minval=1, maxval=100)

// Bollinger Bands Settings
bbLength = input.int(20, "Bollinger Bands Length", minval=1, maxval=100)
bbMult = input.float(2.0, "Bollinger Bands Multiplier", minval=0.1, maxval=5.0)

// Volume Settings
volumeLength = input.int(20, "Volume SMA Length", minval=1, maxval=100)
volumeThreshold = input.float(1.5, "Volume Threshold Multiplier", minval=0.5, maxval=5.0)

// Moving Averages Settings
emaFast = input.int(9, "Fast EMA Length", minval=1, maxval=100)
emaSlow = input.int(21, "Slow EMA Length", minval=1, maxval=100)
sma200 = input.int(200, "200 SMA Length", minval=50, maxval=500)

// Stochastic Settings
stochLength = input.int(14, "Stochastic Length", minval=1, maxval=100)
stochK = input.int(3, "Stochastic %K", minval=1, maxval=20)
stochD = input.int(3, "Stochastic %D", minval=1, maxval=20)

// Williams %R Settings
williamsLength = input.int(14, "Williams %R Length", minval=1, maxval=100)

// ATR Settings
atrLength = input.int(14, "ATR Length", minval=1, maxval=100)
atrMultiplier = input.float(2.0, "ATR Multiplier for Stop Loss", minval=0.5, maxval=5.0)

// ============================================================================
// CALCULATIONS
// ============================================================================
// RSI
rsi = ta.rsi(close, rsiLength)

// MACD
[macdLine, signalLine, histLine] = ta.macd(close, macdFastLength, macdSlowLength, macdSignalLength)

// Bollinger Bands
bbMiddle = ta.sma(close, bbLength)
bbStd = ta.stdev(close, bbLength)
bbUpper = bbMiddle + bbMult * bbStd
bbLower = bbMiddle - bbMult * bbStd

// Volume Analysis
volumeSMA = ta.sma(volume, volumeLength)
volumeRatio = volume / volumeSMA
isHighVolume = volumeRatio > volumeThreshold

// Moving Averages
emaFastLine = ta.ema(close, emaFast)
emaSlowLine = ta.ema(close, emaSlow)
sma200Line = ta.sma(close, sma200)

// Stochastic
[stochKLine, stochDLine] = ta.stoch(close, high, low, stochLength, stochK, stochD)

// Williams %R
williamsR = ta.wpr(williamsLength)

// ATR for Stop Loss
atr = ta.atr(atrLength)

// Price Action Analysis
isAbove200SMA = close > sma200Line
isAboveFastEMA = close > emaFastLine
isAboveSlowEMA = close > emaSlowLine
isEMABullish = emaFastLine > emaSlowLine

// Support and Resistance Levels
highestHigh = ta.highest(high, 20)
lowestLow = ta.lowest(low, 20)
midLevel = (highestHigh + lowestLow) / 2

// ============================================================================
// BUY SIGNAL CONDITIONS
// ============================================================================
// Primary Buy Signals
rsiOversoldSignal = rsi < rsiOversold and rsi > rsi[1]
macdBullishCrossover = ta.crossover(macdLine, signalLine)
macdBullishDivergence = close < close[1] and macdLine > macdLine[1]
bbLowerBounce = close <= bbLower and close > close[1]
volumeBreakout = isHighVolume and close > close[1] and close > bbMiddle

// Secondary Buy Signals
emaBullishCrossover = ta.crossover(emaFastLine, emaSlowLine)
stochOversold = stochKLine < 20 and stochDLine < 20 and stochKLine > stochKLine[1]
williamsOversold = williamsR < -80 and williamsR > williamsR[1]
priceAboveSupport = close > midLevel and close > close[1]

// Advanced Buy Signals
goldenCross = ta.crossover(sma200Line, close)
trendReversal = close > emaSlowLine and close > close[1] and volume > volumeSMA
momentumBreakout = rsi > 50 and rsi < 70 and close > bbMiddle and volume > volumeSMA

// ============================================================================
// SIGNAL STRENGTH CALCULATION
// ============================================================================
signalStrength = 0

// Add points for each confirmed signal
if rsiOversoldSignal
    signalStrength := signalStrength + 1
if macdBullishCrossover
    signalStrength := signalStrength + 2
if macdBullishDivergence
    signalStrength := signalStrength + 1
if bbLowerBounce
    signalStrength := signalStrength + 1
if volumeBreakout
    signalStrength := signalStrength + 2
if emaBullishCrossover
    signalStrength := signalStrength + 2
if stochOversold
    signalStrength := signalStrength + 1
if williamsOversold
    signalStrength := signalStrength + 1
if priceAboveSupport
    signalStrength := signalStrength + 1
if goldenCross
    signalStrength := signalStrength + 3
if trendReversal
    signalStrength := signalStrength + 2
if momentumBreakout
    signalStrength := signalStrength + 2

// Additional strength for trend alignment
if isAbove200SMA
    signalStrength := signalStrength + 1
if isEMABullish
    signalStrength := signalStrength + 1
if isHighVolume
    signalStrength := signalStrength + 1

// ============================================================================
// BUY SIGNAL GENERATION
// ============================================================================
strongBuySignal = signalStrength >= 6
moderateBuySignal = signalStrength >= 4 and signalStrength < 6
weakBuySignal = signalStrength >= 2 and signalStrength < 4

// ============================================================================
// STOP LOSS AND TAKE PROFIT CALCULATIONS
// ============================================================================
stopLoss = close - (atr * atrMultiplier)
takeProfit = close + (atr * atrMultiplier * 2)

// Risk-Reward Ratio
riskRewardRatio = (takeProfit - close) / (close - stopLoss)

// ============================================================================
// PLOTTING
// ============================================================================
// Plot Moving Averages
plot(emaFastLine, "Fast EMA", color=color.blue, linewidth=2)
plot(emaSlowLine, "Slow EMA", color=color.red, linewidth=2)
plot(sma200Line, "200 SMA", color=color.yellow, linewidth=3)

// Plot Bollinger Bands
plot(bbUpper, "BB Upper", color=color.gray, linewidth=1)
plot(bbMiddle, "BB Middle", color=color.gray, linewidth=1)
plot(bbLower, "BB Lower", color=color.gray, linewidth=1)

// Fill Bollinger Bands
fill(plot(bbUpper), plot(bbLower), color=color.new(color.blue, 90))

// Plot Buy Signals
plotshape(strongBuySignal, "Strong Buy", shape.triangleup, location.belowbar, color.green, size=size.large)
plotshape(moderateBuySignal, "Moderate Buy", shape.triangleup, location.belowbar, color.yellow, size=size.normal)
plotshape(weakBuySignal, "Weak Buy", shape.triangleup, location.belowbar, color.orange, size=size.small)

// Plot Stop Loss and Take Profit levels when signal is active
plot(strongBuySignal ? stopLoss : na, "Stop Loss", color=color.red, linewidth=2, style=plot.style_line)
plot(strongBuySignal ? takeProfit : na, "Take Profit", color=color.green, linewidth=2, style=plot.style_line)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(strongBuySignal, "Strong Buy Signal", "Strong buy signal detected with signal strength: {{plot('Signal Strength')}}")
alertcondition(moderateBuySignal, "Moderate Buy Signal", "Moderate buy signal detected with signal strength: {{plot('Signal Strength')}}")
alertcondition(weakBuySignal, "Weak Buy Signal", "Weak buy signal detected with signal strength: {{plot('Signal Strength')}}")

// ============================================================================
// TABLE DISPLAY
// ============================================================================
if barstate.islast
    var table infoTable = table.new(position.top_right, 2, 12, bgcolor=color.white, border_width=1)
    
    table.cell(infoTable, 0, 0, "Signal Strength", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, str.tostring(signalStrength), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 1, "RSI", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 1, str.tostring(math.round(rsi, 2)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 2, "MACD", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 2, str.tostring(math.round(macdLine, 4)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 3, "Volume Ratio", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 3, str.tostring(math.round(volumeRatio, 2)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 4, "BB Position", text_color=color.black, bgcolor=color.gray)
    bbPosition = ((close - bbLower) / (bbUpper - bbLower)) * 100
    table.cell(infoTable, 1, 4, str.tostring(math.round(bbPosition, 1)) + "%", text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 5, "Risk/Reward", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 5, str.tostring(math.round(riskRewardRatio, 2)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 6, "Stop Loss", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 6, str.tostring(math.round(stopLoss, 2)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 7, "Take Profit", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 7, str.tostring(math.round(takeProfit, 2)), text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 8, "Trend Status", text_color=color.black, bgcolor=color.gray)
    trendStatus = isAbove200SMA ? "Bullish" : "Bearish"
    table.cell(infoTable, 1, 8, trendStatus, text_color=color.black, bgcolor=color.white)
    
    table.cell(infoTable, 0, 9, "Signal Type", text_color=color.black, bgcolor=color.gray)
    signalType = strongBuySignal ? "Strong Buy" : moderateBuySignal ? "Moderate Buy" : weakBuySignal ? "Weak Buy" : "No Signal"
    table.cell(infoTable, 1, 9, signalType, text_color=color.black, bgcolor=color.white)

// ============================================================================
// PLOT SIGNAL STRENGTH
// ============================================================================
plot(signalStrength, "Signal Strength", color=color.purple, linewidth=2, display=display.none)